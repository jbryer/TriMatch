<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Propensity Score Matching with Three Groups • TriMatch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Propensity Score Matching with Three Groups">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TriMatch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/TriMatch.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jbryer/TriMatch/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Propensity Score Matching with Three Groups</h1>
                        <h4 data-toc-skip class="author">Jason
Bryer</h4>
                  <a class="author_email" href="mailto:#"></a><a href="mailto:jason.bryer@cuny.edu" class="email">jason.bryer@cuny.edu</a>
      
                  
            <h4 data-toc-skip class="date">2025-04-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jbryer/TriMatch/blob/HEAD/vignettes/TriMatch.Rmd" class="external-link"><code>vignettes/TriMatch.Rmd</code></a></small>
      <div class="d-none name"><code>TriMatch.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      The use of propensity score methods <span class="citation">(Rosenbaum and Rubin 1983)</span> have become
      popular for estimating causal inferences in observational studies
      in medical research <span class="citation">(Austin 2008)</span>
      and in the social sciences <span class="citation">(Thoemmes and
      Kim 2011)</span>. In most cases however, the use of propensity
      score methods have been confined to a single treatment. Several
      researchers have suggested using propensity score methods with
      multiple control groups, or to simply perform two separate
      analyses, one between treatment one and the control and another
      between treatment two and control. This paper introduces the
      TriMatch package for R that provides a method for determining
      matched triplets. Examples from educational and medical contexts
      will be discussed.
    </div>
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://jbryer.github.io/TriMatch" class="external-link">TriMatch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"tutoring"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"nmes"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Consider two treatments,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><msub><mi>r</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">Tr_1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><msub><mi>r</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">Tr_2</annotation></semantics></math>,
and a control,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>.
We estimate propensity scores with three separate logistic regression
models where model one predicts
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><msub><mi>r</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">Tr_1</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>,
model two predicts
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><msub><mi>r</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">Tr_2</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>,
and model three predicts
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><msub><mi>r</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">Tr_1</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><msub><mi>r</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">Tr_2</annotation></semantics></math>.
The triangle plot in Figure @ref(fig:triangleplot) depicts the fitted
values (i.e. propensity scores) from the three models on each edge of
the triangle. Since each unit has a propensity score in two of the three
models, their scores are connected. We can then calculate three
distances between propensity scores for each possible matched triplet
using the three models. Given those distances, the matched triplets with
the smallest standardized distance
(i.e. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></msub><mo>=</mo><mfrac><mrow><mo stretchy="true" form="prefix">|</mo><mi>P</mi><msub><mi>S</mi><mi>x</mi></msub><mo>−</mo><mi>P</mi><msub><mi>S</mi><mi>y</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><mrow><mi>s</mi><mi>d</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mi>S</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">D_{x,y} = \frac{| PS_{x} - PS_{y} |}{sd(PS)}</annotation></semantics></math>)
are retained. Several methods for determining which matched triplets to
retain are provided with the possibility of the researcher to implement
their own. The black lines in Figure @ref(fig:triangleplot) represent
one matched triplet (i.e. one row in the returned data frame).</p>
<p>Propensity score analysis of two groups typically use dependent
sample <em>t</em>-tests <span class="citation">(Austin 2010)</span>. The
analogue for matched triplets include repeated measures ANOVA and the
Freidman Rank Sum Test. The <code>TriMatch</code> package provides
utility functions for conducting and visualizing these statistical
tests. Moreover, a set of functions extending <code>PSAgraphics</code>
<span class="citation">(Helmreich and Pruzek 2009)</span> for matched
triplets to check covariate balance are provided.</p>
<div class="section level3">
<h3 id="the-trimatch-algorithm">The <code>TriMatch</code> Algorithm<a class="anchor" aria-label="anchor" href="#the-trimatch-algorithm"></a>
</h3>
<p>The <code>trips</code> and <code>trimatch</code> functions are used
to estimate the propensity scores and find the best matched triplets,
respectively.</p>
<p>A. Propensity scores are estimated for three models using logistic
regression.
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>P</mi><mi>S</mi></mrow><mn>1</mn></msub><mo>=</mo><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><msub><mi>T</mi><mn>1</mn></msub><mi>C</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><msub><mi>T</mi><mn>1</mn></msub><mi>C</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">{ PS }_{ 1 }=e({ x }_{ { T }_{ 1 }C })=Pr(z=1|{ X }_{ { T }_{ 1 }C })</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>P</mi><mi>S</mi></mrow><mn>2</mn></msub><mo>=</mo><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><msub><mi>T</mi><mn>2</mn></msub><mi>C</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><msub><mi>T</mi><mn>2</mn></msub><mi>C</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">{ PS }_{ 2 }=e({ x }_{ { T }_{ 2 }C })=Pr(z=1|{ X}_{ { T }_{ 2 }C })</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>P</mi><mi>S</mi></mrow><mn>3</mn></msub><mo>=</mo><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><msub><mi>T</mi><mn>2</mn></msub><msub><mi>T</mi><mn>1</mn></msub></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><msub><mi>T</mi><mn>2</mn></msub><msub><mi>T</mi><mn>1</mn></msub></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">{ PS }_{ 3 }=e({ x }_{ { T }_{ 2 }{ T }_{ 1 } })=Pr(z=1|{ X }_{ { T }_{ 2 }{ T }_{ 1 } })</annotation></semantics></math></p>
<p>B. Match order is determined. The default is to start with the larger
of the two treatments, followed the second treatment, and lastly the
control group. However, the match order is configurable vis-a-vis the
<code>match.order</code> parameter.</p>
<p>C. Three distance matrices are calculated,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>1</mn></msub><annotation encoding="application/x-tex">D_1</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>2</mn></msub><annotation encoding="application/x-tex">D_2</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>3</mn></msub><annotation encoding="application/x-tex">D_3</annotation></semantics></math>
corresponding to the propensity scores estimated in step @ref(item:ps).
That is,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mn>1</mn></msub><annotation encoding="application/x-tex">D_1</annotation></semantics></math>
is a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mrow><mi>T</mi><msub><mi>r</mi><mn>1</mn></msub></mrow></msub><annotation encoding="application/x-tex">n_{Tr_1}</annotation></semantics></math>
x
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mrow><mi>T</mi><msub><mi>r</mi><mn>2</mn></msub></mrow></msub><annotation encoding="application/x-tex">n_{Tr_2}</annotation></semantics></math>
matrix where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">[</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">D_1[x,y]</annotation></semantics></math>
is the standardized distance between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>S</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">[</mo><mi>x</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">PS_1[x]</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>S</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">[</mo><mi>y</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">PS_1[y]</annotation></semantics></math>.</p>
<p>D. Distances greater than the caliper, 0.25 by default as recommended
by <span class="citation">(Rosenbaum and Rubin 1985)</span>, are
eliminated. The caliper is specified in standard units so 0.25
corresponds to one-quarter of one standard deviation.</p>
<p>E. If partial exact matching is desired, three logical matrices are
created with the same dimensions as the distance matrices calculated in
step @ref(item:distance). That is, position
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x,y</annotation></semantics></math>
in the matrix is true if the covariate(s) to match exactly on between
unit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>
match exactly. Distances where exact there are not exact matches are
eliminated.</p>
<p>F. For the remaining units, all possible combinations of matched
triplets are formed and a total standardized distance is calculated.</p>
<p>The result of the above procedure is the equivalent of caliper
matching in the two group case. That is, all possible matches within a
specified caliper are retained. This can be achieved by specifying
<code>method = NULL</code> parameter to the <code>trimatch</code>
function. Two additional methods are provided to reduce the number of
matched triplets. The <code>maximumTreat</code> method attempts to
reduce the number of duplicate treatment units. This is analogous to
matching without replacement in the two group case. However, treatment 1
units may be matched to two different treatment 2 units if that
treatment 2 unit would otherwise not be matched. The <code>OneToN</code>
method will allow the user to specify exactly how many times each
treatment 1 and treatment 2 may be reused.</p>
</div>
</div>
<div class="section level2">
<h2 id="effects-of-tutoring-on-course-grades">Effects of Tutoring on Course Grades<a class="anchor" aria-label="anchor" href="#effects-of-tutoring-on-course-grades"></a>
</h2>
<p>In the first example we will utilize observational data obtained to
evaluate the effectiveness of tutoring services on course grades.
Treatment students consisted of those students who used tutoring
services while enrolled in a online writing course between 2008 and
2011. A comparison group was identified as students enrolled in a course
section with a student who used tutoring services. The treatment group
was then divided into two based upon the number of times they utilized
tutoring services. “Novice” users are those who used the services once
and “regular” users are those who used services two or more times.
Covariates available for estimating propensity scores are gender,
ethnicity, military status, English second language learner, educational
level for mother and father, age at the beginning of the course,
employment level at college enrollment, income level at college
enrollment, number of transfer credits, and GPA at the start of the
course.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tutoring</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "treat"      "Course"     "Grade"      "Gender"     "Ethnicity" </span></span>
<span><span class="co">#&gt;  [6] "Military"   "ESL"        "EdMother"   "EdFather"   "Age"       </span></span>
<span><span class="co">#&gt; [11] "Employment" "Income"     "Transfer"   "GPA"        "GradeCode" </span></span>
<span><span class="co">#&gt; [16] "Level"      "ID"</span></span></code></pre></div>
<p>The courses represented here are structured such that the variation
from section-to-section is minimal. However, the differences between
courses is substantial and therefore we will utilize partial exact
matching so that all matched students will have taken the same
course.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">tutoring</span><span class="op">$</span><span class="va">treat</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Course</span>, useNA<span class="op">=</span><span class="st">"ifany"</span><span class="op">)</span></span>
<span><span class="co">#&gt;          </span></span>
<span><span class="co">#&gt;           ENG*101 ENG*201 HSC*310</span></span>
<span><span class="co">#&gt;   Control     349     518      51</span></span>
<span><span class="co">#&gt;   Treat1       22      36      76</span></span>
<span><span class="co">#&gt;   Treat2       31      32      27</span></span></code></pre></div>
<p>The first step of analysis is to estimate the propensity scores. The
<code>trips</code> function will estimate three propensity score models,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">PS_1</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>S</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">PS_2</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>S</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">PS_3</annotation></semantics></math>
as described above. Note that when specifying the formula the dependent
variable, or treatment indicator, is not included. The
<code>trips</code> function will replace the dependent variable as it
estimates the three logistic regression models.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formu</span> <span class="op">&lt;-</span> <span class="op">~</span> <span class="va">Gender</span> <span class="op">+</span> <span class="va">Ethnicity</span> <span class="op">+</span> <span class="va">Military</span> <span class="op">+</span> <span class="va">ESL</span> <span class="op">+</span> <span class="va">EdMother</span> <span class="op">+</span> <span class="va">EdFather</span> <span class="op">+</span> </span>
<span><span class="va">Age</span> <span class="op">+</span> <span class="va">Employment</span> <span class="op">+</span> <span class="va">Income</span> <span class="op">+</span> <span class="va">Transfer</span> <span class="op">+</span> <span class="va">GPA</span></span>
<span><span class="va">tutoring.tpsa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trips.html">trips</a></span><span class="op">(</span><span class="va">tutoring</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">treat</span>, <span class="va">formu</span><span class="op">)</span></span></code></pre></div>
<p>Figure @ref(fig:triangleplot) is a triangle plot that depicts the
propensity scores from the three models. Since each student has two
propensity scores, their scores are connected with a line. The black
line in Figure @ref(fig:triangleplot) represents one matched triplet
estimated below.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tutoring.tpsa</span><span class="op">)</span></span></code></pre></div>
<p><img src="TriMatch_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The default for <code>trimatch</code> is to use the
<code>maximumTreat</code> method retaining each treatment unit once with
treatment one units matched more than once only if the corresponding
treatment two unit would not be matched otherwise.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tutoring.matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimatch.html">trimatch</a></span><span class="op">(</span><span class="va">tutoring.tpsa</span>, exact<span class="op">=</span><span class="va">tutoring</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Course"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Setting the <code>method</code> parameter to <code>NULL</code> will
result in caliper matching. All matched triplets within the specified
caliper are retained. This will result in the largest number of matched
triplets.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tutoring.matched.caliper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimatch.html">trimatch</a></span><span class="op">(</span><span class="va">tutoring.tpsa</span>, </span>
<span>exact<span class="op">=</span><span class="va">tutoring</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Course"</span><span class="op">)</span><span class="op">]</span>, method<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>Lastly, we will use the <code>OneToN</code> method to retain a
2-to-1-to-n and 3-to-2-n matches.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tutoring.matched.2to1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimatch.html">trimatch</a></span><span class="op">(</span><span class="va">tutoring.tpsa</span>, </span>
<span>exact<span class="op">=</span><span class="va">tutoring</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Course"</span><span class="op">)</span><span class="op">]</span>, method<span class="op">=</span><span class="va">OneToN</span>, M1<span class="op">=</span><span class="fl">2</span>, M2<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">tutoring.matched.3to2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimatch.html">trimatch</a></span><span class="op">(</span><span class="va">tutoring.tpsa</span>, </span>
<span>exact<span class="op">=</span><span class="va">tutoring</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Course"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>method<span class="op">=</span><span class="va">OneToN</span>, M1<span class="op">=</span><span class="fl">3</span>, M2<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tutoring.matched</span>, rows<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>, line.alpha<span class="op">=</span><span class="fl">1</span>, draw.segments<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/triangleplot-1.png" alt="Traingle Plot" width="700"><p class="caption">
Traingle Plot
</p>
</div>
<div class="section level3">
<h3 id="examining-unmatched-students">Examining Unmatched Students<a class="anchor" aria-label="anchor" href="#examining-unmatched-students"></a>
</h3>
<p>The different methods for retaining matched triplets address the
issue of overrepresentation of treatment units. In this example there
four times as many control units as treatment units (the ratio is larger
when considering the treatments separately). These methods fall on a
spectrum where each treatment unit is used minimally
(<code>maximumTreat</code> method) or all units are used (caliper
matching). <span class="citation">(Rosenbaum 2012)</span> suggests
testing hypothesis more than once and it is our general recommendation
to utilize multiple methods. Functions to help present and compare the
results from multiple methods are provided and discussed below.</p>
<p>The <code>unmatched</code> function will return the rows of students
who were not matched. The <code>summary</code> function will provide
information about how many students within each group were not matched.
As shown below, the caliper matching will match the most students. In
this particular example, in fact, the only substantial difference in the
unmatched students is with the control group. All methods fail to match
37 treatment one students. This is due to the fact that there is not
another student within the specified caliper that match exactly on the
course.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/unmatched.html">unmatched</a></span><span class="op">(</span><span class="va">tutoring.matched</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 892 (78.1%) of 1142 total data points were not matched.</span></span>
<span><span class="co">#&gt; Unmatched by treatment:</span></span>
<span><span class="co">#&gt;     Control      Treat1      Treat2 </span></span>
<span><span class="co">#&gt; 834 (90.8%)  39 (29.1%)  19 (21.1%)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/unmatched.html">unmatched</a></span><span class="op">(</span><span class="va">tutoring.matched.caliper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 638 (55.9%) of 1142 total data points were not matched.</span></span>
<span><span class="co">#&gt; Unmatched by treatment:</span></span>
<span><span class="co">#&gt;     Control      Treat1      Treat2 </span></span>
<span><span class="co">#&gt; 580 (63.2%)  39 (29.1%)  19 (21.1%)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/unmatched.html">unmatched</a></span><span class="op">(</span><span class="va">tutoring.matched.2to1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1000 (87.6%) of 1142 total data points were not matched.</span></span>
<span><span class="co">#&gt; Unmatched by treatment:</span></span>
<span><span class="co">#&gt;     Control      Treat1      Treat2 </span></span>
<span><span class="co">#&gt; 870 (94.8%)  97 (72.4%)  33 (36.7%)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/unmatched.html">unmatched</a></span><span class="op">(</span><span class="va">tutoring.matched.3to2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 928 (81.3%) of 1142 total data points were not matched.</span></span>
<span><span class="co">#&gt; Unmatched by treatment:</span></span>
<span><span class="co">#&gt;     Control      Treat1      Treat2 </span></span>
<span><span class="co">#&gt; 831 (90.5%)    75 (56%)  22 (24.4%)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="checking-balance">Checking Balance<a class="anchor" aria-label="anchor" href="#checking-balance"></a>
</h3>
<p>The eventual strength of propensity score methods is dependent on how
well balance is achieved. <span class="citation">(Helmreich and Pruzek
2009)</span> introduced graphical approaches to evaluating balance. We
provide functions that extend that framework to matching of three
groups. Figure @ref(fig:multibalance) is a multiple covariate balance
plot that plots the absolute effect size of each covariate before and
after adjustment. In this example, the figure suggests that reasonable
balance has been achieved across all covariates and across all three
models since effect sizes are smaller than the unadjusted in most cases
and relatively small.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/multibalance.plot.html">multibalance.plot</a></span><span class="op">(</span><span class="va">tutoring.tpsa</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Covariate Balance Plot"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/multibalance-1.png" alt="Multiple Covariate Balance Plot of Absolute Standardized Effect Sizes Before and After Propensity Score Adjustment" width="700"><p class="caption">
Multiple Covariate Balance Plot of Absolute Standardized Effect Sizes
Before and After Propensity Score Adjustment
</p>
</div>
<p>Figure @ref(fig:balance) is the results of the
<code>balance.plot</code> function. This function will provide a bar
chart for categorical covariates and box plots for quantitative
covariates, individually or in a grid.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bplots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/balance.plot.html">balance.plot</a></span><span class="op">(</span><span class="va">tutoring.matched</span>, <span class="va">tutoring</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/allnames.html" class="external-link">all.vars</a></span><span class="op">(</span><span class="va">formu</span><span class="op">)</span><span class="op">]</span>, </span>
<span>        legend.position<span class="op">=</span><span class="st">"none"</span>, x.axis.labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"C"</span>,<span class="st">"T1"</span>,<span class="st">"T1"</span><span class="op">)</span>, x.axis.angle<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bplots</span>, cols<span class="op">=</span><span class="fl">3</span>, byrow<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/balance-1.png" alt="Covariate Balance Plots" width="700"><p class="caption">
Covariate Balance Plots
</p>
</div>
<pre><code><span><span class="co">#&gt; NULL</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="phase-ii-estimating-effects-of-tutoring-on-course-grades">Phase II: Estimating Effects of Tutoring on Course Grades<a class="anchor" aria-label="anchor" href="#phase-ii-estimating-effects-of-tutoring-on-course-grades"></a>
</h3>
<p>In phase two of propensity score analysis we wish to compare our
outcome of interest, course grade in this example, across the matches. A
custom <code>merge</code> function is provided to merge an outcome from
the original data frame to the results of <code>trimatch</code>. This
merge function will add three columns with the outcome for each of the
three groups.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matched.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">tutoring.matched</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">matched.out</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Treat1"      "Treat2"      "Control"     "D.m3"        "D.m2"       </span></span>
<span><span class="co">#&gt;  [6] "D.m1"        "Dtotal"      "Treat1.out"  "Treat2.out"  "Control.out"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">matched.out</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Treat1 Treat2 Control        D.m3        D.m2         D.m1     Dtotal</span></span>
<span><span class="co">#&gt; 1    368     39     331 0.007053754 0.001788577 1.039322e-02 0.01923555</span></span>
<span><span class="co">#&gt; 2    158    279     365 0.003373585 0.009530680 1.071188e-02 0.02361614</span></span>
<span><span class="co">#&gt; 3    899    209     100 0.001929173 0.013633300 9.183572e-03 0.02474604</span></span>
<span><span class="co">#&gt; 4    692    596    1055 0.023785086 0.010292177 1.862058e-03 0.03593932</span></span>
<span><span class="co">#&gt; 5    616    209     208 0.020203398 0.016562521 3.168865e-05 0.03679761</span></span>
<span><span class="co">#&gt; 6     28    852     154 0.007501996 0.014214100 1.776640e-02 0.03948249</span></span>
<span><span class="co">#&gt;   Treat1.out Treat2.out Control.out</span></span>
<span><span class="co">#&gt; 1          4          4           0</span></span>
<span><span class="co">#&gt; 2          4          4           4</span></span>
<span><span class="co">#&gt; 3          4          3           4</span></span>
<span><span class="co">#&gt; 4          4          3           4</span></span>
<span><span class="co">#&gt; 5          4          3           0</span></span>
<span><span class="co">#&gt; 6          4          4           2</span></span></code></pre></div>
<p>Although the <code>merge</code> function is convenient for conducting
your own analysis, the <code>summary</code> function will perform the
most common analyses including Friedman Rank Sum test and repeated
measures ANOVA. If either of those tests produce a <em>p</em> value less
than the specified threshold (0.05 by default), then the
<code>summary</code> function will also perform and return Wilcoxon
signed rank test and three separate dependent sample <em>t</em>-tests
see <span class="citation">(Austin 2010)</span> for discussion of
dependent versus independent <em>t</em>-tests.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tutoring.matched</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "PercentMatched"       "friedman.test"        "rmanova"             </span></span>
<span><span class="co">#&gt; [4] "pairwise.wilcox.test" "t.tests"</span></span>
<span><span class="va">s1</span><span class="op">$</span><span class="va">friedman.test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Friedman rank sum test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  Outcome and Treatment and ID</span></span>
<span><span class="co">#&gt; Friedman chi-squared = 27.904, df = 2, p-value = 8.726e-07</span></span>
<span><span class="va">s1</span><span class="op">$</span><span class="va">t.tests</span></span>
<span><span class="co">#&gt;               Treatments         t  df      p.value sig  mean.diff     ci.min</span></span>
<span><span class="co">#&gt; 1  Treat1.out-Treat2.out -2.791302 117 6.132601e-03  ** -0.3220339 -0.5505191</span></span>
<span><span class="co">#&gt; 2 Treat1.out-Control.out  3.817862 117 2.168534e-04 ***  0.7033898  0.3385190</span></span>
<span><span class="co">#&gt; 3 Treat2.out-Control.out  6.922623 117 2.539540e-10 ***  1.0254237  0.7320670</span></span>
<span><span class="co">#&gt;        ci.max</span></span>
<span><span class="co">#&gt; 1 -0.09354868</span></span>
<span><span class="co">#&gt; 2  1.06826071</span></span>
<span><span class="co">#&gt; 3  1.31878047</span></span></code></pre></div>
<p>The <code>print</code> method will accept multiple object returned by
<code>summary</code> so to combine them into a single table output. Note
that each parameter must be named and that name will be used to identify
the row containing those results.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tutoring.matched.caliper</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span><span class="op">)</span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tutoring.matched.2to1</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span><span class="op">)</span></span>
<span><span class="va">s4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tutoring.matched.3to2</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Max Treat"</span><span class="op">=</span><span class="va">s1</span>, <span class="st">"Caliper"</span><span class="op">=</span><span class="va">s2</span>, <span class="st">"2-to-1"</span><span class="op">=</span><span class="va">s3</span>, <span class="st">"3-to-2"</span><span class="op">=</span><span class="va">s4</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Method Friedman.chi2   Friedman.p     rmANOVA.F    rmANOVA.p    </span></span>
<span><span class="co">#&gt; 1 Max Treat      27.90354 8.726175e-07 ***  23.84506 3.758176e-10 ***</span></span>
<span><span class="co">#&gt; 2   Caliper     112.99646 2.904890e-25 *** 108.21057 2.374092e-45 ***</span></span>
<span><span class="co">#&gt; 3    2-to-1      18.95541 7.653924e-05 ***  15.54945 1.097932e-06 ***</span></span>
<span><span class="co">#&gt; 4    3-to-2      32.27083 9.828281e-08 ***  25.03567 1.538341e-10 ***</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/boxdiff.plot.html">boxdiff.plot</a></span><span class="op">(</span><span class="va">tutoring.matched</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span>, </span>
<span>             ordering<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treat2"</span>,<span class="st">"Treat1"</span>,<span class="st">"Control"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Maximum Treatment Matching"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/boxdiff.plot.html">boxdiff.plot</a></span><span class="op">(</span><span class="va">tutoring.matched.caliper</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span>, </span>
<span>             ordering<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treat2"</span>,<span class="st">"Treat1"</span>,<span class="st">"Control"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Caliper Matching"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/boxdiff.plot.html">boxdiff.plot</a></span><span class="op">(</span><span class="va">tutoring.matched.2to1</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span>, </span>
<span>             ordering<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treat2"</span>,<span class="st">"Treat1"</span>,<span class="st">"Control"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"2-to-1-to-n Matching"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/boxplots-1.png" alt="Boxplot of Differences" width="30%"><img src="TriMatch_files/figure-html/boxplots-2.png" alt="Boxplot of Differences" width="30%"><img src="TriMatch_files/figure-html/boxplots-3.png" alt="Boxplot of Differences" width="30%"><p class="caption">
Boxplot of Differences
</p>
</div>
<p>Another useful visualization for presenting the results is the Loess
plot. In Figure @ref(fig:loess) we plot the propensity scores on the
<em>x</em>-axis and the outcome (grade in this example) on the
<em>y</em>-axis. A Loess regression line is then overlaid.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;We utilize the &lt;code&gt;geom_smooth&lt;/code&gt; geometry in the
&lt;code&gt;ggplot2&lt;/code&gt; package that provides other smoothing functions
including linear modeling (&lt;code&gt;lm&lt;/code&gt;), generalized linear modeling
(&lt;code&gt;glm&lt;/code&gt;), and robust generalized additive models
(&lt;code&gt;gam&lt;/code&gt;). See the documentation for the
&lt;code&gt;stat_smooth&lt;/code&gt; function in &lt;code&gt;ggplot2&lt;/code&gt;.&lt;/p&gt;"><sup>1</sup></a> Since there are three
propensity score scales, the <code>plot.loess3</code> function will use
the propensity scores from the model predicting treatment one from
treatment two. Propensity scores for the control group are then imputed
by taking the mean of the propensity scores of the two treatment units
that control was matched to. It should be noted that if a control unit
is matched to two different sets of treatment units, then that control
unit will have two propensity scores. Which propensity score scale is
utilized can be explicitly specified using the <code>model</code>
parameter.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loess3.plot.html">loess3.plot</a></span><span class="op">(</span><span class="va">tutoring.matched.caliper</span>, <span class="va">tutoring</span><span class="op">$</span><span class="va">Grade</span>, ylab<span class="op">=</span><span class="st">"Grade"</span>, </span>
<span>            points.alpha<span class="op">=</span><span class="fl">.1</span>, method<span class="op">=</span><span class="st">"loess"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/loess-1.png" alt="Loess Plot for Caliper Matching" width="700"><p class="caption">
Loess Plot for Caliper Matching
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="effects-of-smoking-on-medical-expenditures">Effects of Smoking on Medical Expenditures<a class="anchor" aria-label="anchor" href="#effects-of-smoking-on-medical-expenditures"></a>
</h2>
<p>In this example<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;This example is included as a demo in the package. Type
&lt;code&gt;demo(nmes)&lt;/code&gt; in R to start the demo.&lt;/p&gt;"><sup>2</sup></a> we will utilize the National Medical
Expenditure Study <span class="citation">(National Center For Health
Services Research 1987)</span> to estimate the effects of smoking on
medical expenditures. This dataset was first used by <span class="citation">(Johnson et al. 2003)</span> to estimate the effects of
smoking on diseases, and then the effect of diseases on medical
expenditures. <span class="citation">(<strong>ImaiVanDyk2004?</strong>)</span> developed an
a method to generalize the propensity score, called a p-score, to
directly estimate the effects of smoking on medical expenditures. More
specifically, they defined a quantitative treatment variable, pack year,
defined as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mo>=</mo><mfrac><mtext mathvariant="normal">number of cigarettes per day</mtext><mn>20</mn></mfrac><mo>×</mo><mtext mathvariant="normal">number of years smoked</mtext></mrow><annotation encoding="application/x-tex">packyear = \frac{\text{number of cigarettes per day}}{20} \times \text{number of years smoked}</annotation></semantics></math></p>
<p>Our approach is designed to match three separate groups and not a
continuous treatment. We will address two research questions: (1) What
are the effects of smoking status (i.e. never smoked, former smoker, and
current smoker) on medical expenditures? and (2) What are the effects of
lifetime smoking on medical expenditures? Figure
@ref(fig:packyearsAndTotalExp) represent the relationship between these
two different treatments<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Note that the control group in both instances are people
who never smoked and is omitted from this figure.&lt;/p&gt;"><sup>3</sup></a>. This figure reveals several, perhaps
counterintuitive, facts. First, the unadjusted total medical
expenditures for former smokers is higher than current smokers.
Secondly, the distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">log(packyear)</annotation></semantics></math>
overlap substantial between former and current smokers. To dichotomize
the pack year smoking variable, we will split on the median of pack
year, labeled moderate smokers
(i.e. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mo>≤</mo><mi>m</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>a</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">packyear \le median(packyear)</annotation></semantics></math>)
and heavy smokers
(i.e. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mo>&gt;</mo><mi>m</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>a</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">packyear &gt; median(packyear)</annotation></semantics></math>).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">)</span></span>
<span><span class="va">nmes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">nmes</span>, select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">packyears</span>, <span class="va">smoke</span>, <span class="va">LASTAGE</span>, <span class="va">MALE</span>, <span class="va">RACE3</span>, <span class="va">beltuse</span>, <span class="va">educate</span>, <span class="va">marital</span>, <span class="va">SREGION</span>, <span class="va">POVSTALB</span>, <span class="va">HSQACCWT</span>, <span class="va">TOTALEXP</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Both <span class="citation">(Johnson et al. 2003)</span> and <span class="citation">(<strong>ImaiVanDyk2004?</strong>)</span> conducted a
complete-case analysis and Johnson et al. reported that multiple
imputation did not substantially affect their results.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nmes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">)</span></span></code></pre></div>
<p>Since many participants had zero medical expenditures, we will add
one to the total expenditures before log transforming the variable. We
will then calculate the median of pack year and create a new treatment
variable, <code>smoke2</code>, for moderate and heavy smokers with
non-smokers.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Never"</span>,<span class="st">"Smoker"</span>,<span class="st">"Former"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nmes</span><span class="op">$</span><span class="va">LogTotalExp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">TOTALEXP</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">medPY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">[</span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span> <span class="op">!=</span> <span class="st">"Never"</span>,<span class="op">]</span><span class="op">$</span><span class="va">packyears</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 17</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">packyears</span> <span class="op">&gt;</span> <span class="va">medPY</span><span class="op">)</span></span>
<span><span class="co">#&gt;         </span></span>
<span><span class="co">#&gt;          FALSE TRUE</span></span>
<span><span class="co">#&gt;   Never   9802    0</span></span>
<span><span class="co">#&gt;   Smoker  2571 2901</span></span>
<span><span class="co">#&gt;   Former  2209 1869</span></span>
<span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span> <span class="op">==</span> <span class="st">"Never"</span>, <span class="st">"Never"</span>, </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">packyears</span> <span class="op">&gt;</span> <span class="fl">17</span>, <span class="st">"Heavy"</span>, <span class="st">"Moderate"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">smoke2</span>, useNA<span class="op">=</span><span class="st">"ifany"</span><span class="op">)</span></span>
<span><span class="co">#&gt;         </span></span>
<span><span class="co">#&gt;          Heavy Moderate Never</span></span>
<span><span class="co">#&gt;   Never      0        0  9802</span></span>
<span><span class="co">#&gt;   Smoker  2901     2571     0</span></span>
<span><span class="co">#&gt;   Former  1869     2209     0</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">[</span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span> <span class="op">!=</span> <span class="st">"Never"</span>,<span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">packyears</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, color<span class="op">=</span><span class="va">smoke</span>, fill<span class="op">=</span><span class="va">smoke</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span>, plot.margin<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">[</span><span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span> <span class="op">!=</span> <span class="st">"Never"</span>,<span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">packyears</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, y<span class="op">=</span><span class="va">LogTotalExp</span>, color<span class="op">=</span><span class="va">smoke</span>, fill<span class="op">=</span><span class="va">smoke</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"loess"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html" class="external-link">scale_color_hue</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html" class="external-link">scale_fill_hue</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.9</span>,<span class="fl">1</span><span class="op">)</span>, plot.margin<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"log(Pack Year)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log(Total Expenditures)"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/packyearsAndTotalExp-1.png" alt="Relationship Between Pack Year and Total Expenditures by Current Smoking Status" width="50%"><img src="TriMatch_files/figure-html/packyearsAndTotalExp-2.png" alt="Relationship Between Pack Year and Total Expenditures by Current Smoking Status" width="50%"><p class="caption">
Relationship Between Pack Year and Total Expenditures by Current Smoking
Status
</p>
</div>
<p>Imai and van Dyk observed that there appeared to be a relationship
between age and medical expenditures. We will create a new categorical
age variable using quintiles to use for partial exact matching. This
serves two purposes, first it ensures balance on this critical covariate
(note that we will also exactly match on gender and ethnicity) and two,
decrease the search space for matched triplets therefore increasing the
efficiency of the matching algorithm. The possible disadvantage of exact
matching is that too many treated units will not be matched. We will
examine unmatched treatment units below.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nmes</span><span class="op">$</span><span class="va">LastAge5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">LASTAGE</span>, </span>
<span>breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">nmes</span><span class="op">$</span><span class="va">LASTAGE</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>include.lowest<span class="op">=</span><span class="cn">TRUE</span>, orderd_result<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Define our model to estimate the propensity scores.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formu</span> <span class="op">&lt;-</span> <span class="op">~</span> <span class="va">LASTAGE</span> <span class="op">+</span> <span class="va">MALE</span> <span class="op">+</span> <span class="va">RACE3</span> <span class="op">+</span> <span class="va">beltuse</span> <span class="op">+</span> <span class="va">educate</span> <span class="op">+</span> <span class="va">marital</span> <span class="op">+</span> </span>
<span><span class="va">SREGION</span> <span class="op">+</span> <span class="va">POVSTALB</span></span></code></pre></div>
<p>Estimate propensity scores for our two different treatments. Figure
@ref(fig:nmestriangleplot) provides triangle plots for both models.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tpsa.smoke</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trips.html">trips</a></span><span class="op">(</span><span class="va">nmes</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">smoke</span>, <span class="va">formu</span><span class="op">)</span></span>
<span><span class="va">tpsa.packyears</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trips.html">trips</a></span><span class="op">(</span><span class="va">nmes</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">smoke2</span>, <span class="va">formu</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p.smoke</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tpsa.smoke</span>, sample<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span><span class="op">)</span>, edge.alpha<span class="op">=</span><span class="fl">.1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Treatment Variable: Current Smoking Status"</span><span class="op">)</span></span>
<span><span class="va">p.packyears</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tpsa.packyears</span>, sample<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span><span class="op">)</span>, edge.alpha<span class="op">=</span><span class="fl">.1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Treatment Variable: Lifetime Smoking Frequency"</span><span class="op">)</span></span>
<span><span class="va">p.smoke</span></span>
<span><span class="va">p.packyears</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/nmestriangleplot-1.png" alt="Triangle Plots for NMES" width="50%"><img src="TriMatch_files/figure-html/nmestriangleplot-2.png" alt="Triangle Plots for NMES" width="50%"><p class="caption">
Triangle Plots for NMES
</p>
</div>
<p>Create two sets of matched triplets for our two treatments.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmatch.smoke</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimatch.html">trimatch</a></span><span class="op">(</span><span class="va">tpsa.smoke</span>, </span>
<span>exact<span class="op">=</span><span class="va">nmes</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LastAge5"</span>,<span class="st">"MALE"</span>,<span class="st">"RACE3"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">tmatch.packyears</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimatch.html">trimatch</a></span><span class="op">(</span><span class="va">tpsa.packyears</span>, </span>
<span>exact<span class="op">=</span><span class="va">nmes</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LastAge5"</span>,<span class="st">"MALE"</span>,<span class="st">"RACE3"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>The following summary of the unmatched rows show that more than 96%
of the treatment units were matched in both models.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/unmatched.html">unmatched</a></span><span class="op">(</span><span class="va">tmatch.smoke</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 7049 (36.4%) of 19352 total data points were not matched.</span></span>
<span><span class="co">#&gt; Unmatched by treatment:</span></span>
<span><span class="co">#&gt;        Never       Smoker       Former </span></span>
<span><span class="co">#&gt; 6805 (69.4%)   142 (2.6%)   102 (2.5%)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/unmatched.html">unmatched</a></span><span class="op">(</span><span class="va">tmatch.packyears</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 7532 (38.9%) of 19352 total data points were not matched.</span></span>
<span><span class="co">#&gt; Unmatched by treatment:</span></span>
<span><span class="co">#&gt;        Heavy     Moderate        Never </span></span>
<span><span class="co">#&gt;  181 (3.79%)  323 (6.76%) 7028 (71.7%)</span></span></code></pre></div>
<p>Figure @ref(fig:nmesbalance) is a multiple covariate balance plot for
the two treatments. It shows that the absolute effect sizes after
adjustment is better for all covariates. The demo included in the
<code>TriMatch</code> package provides functions to create individual
balance plots for each covaraite.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p.smoke</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multibalance.plot.html">multibalance.plot</a></span><span class="op">(</span><span class="va">tpsa.smoke</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Treatment Variable: Current Smoking Status"</span><span class="op">)</span></span>
<span><span class="va">p.packyears</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multibalance.plot.html">multibalance.plot</a></span><span class="op">(</span><span class="va">tpsa.packyears</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Treatment Variable: Lifetime Smoking Frequency"</span><span class="op">)</span></span>
<span><span class="va">p.smoke</span></span>
<span><span class="va">p.packyears</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/nmesbalance-1.png" alt="Multiple Covariate Balance Plots for NMES" width="50%"><img src="TriMatch_files/figure-html/nmesbalance-2.png" alt="Multiple Covariate Balance Plots for NMES" width="50%"><p class="caption">
Multiple Covariate Balance Plots for NMES
</p>
</div>
<div class="section level3">
<h3 id="phase-ii-estimating-effects-of-smoking-on-medical-expenditures">Phase II: Estimating Effects of Smoking on Medical Expenditures<a class="anchor" aria-label="anchor" href="#phase-ii-estimating-effects-of-smoking-on-medical-expenditures"></a>
</h3>
<p>For both treatment regimes we used the <code>maximumTreat</code>
method for finding matched triplets that will retain each treatment unit
once with the possibility of using treatment units twice in cases where
a treatment unit would not otherwise be matched. The Friedman Rank Sum
Test and repeated measures ANOVA indicate there a statistically
significant difference in both treatment regimes. Figure
@ref(fig:nmesboxplots) provides box plots of the differences for the two
treatment regimes. For the current smoking status treatment, the results
indicate that smoker’s actually spend less than former and non-smokers.
However, as <span class="citation">(<strong>ImaiVanDyk2004?</strong>)</span> explain, the
sample of smokers includes only survivors and should be considered when
interpreting these results.</p>
<p>Imai and van Dyk’s analysis used pack year as treatment indicator.
Our dichotomizing of pack year into moderate and heavy smokers more
closely adheres to their approach. The results with this treatment
regime indicate that smokers, both moderate and heavy, have higher
medical expenditures than non-smokers. However, there is no
statistically significant difference between heavy and moderate smokers
in medical expenditures.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/boxdiff.plot.html">boxdiff.plot</a></span><span class="op">(</span><span class="va">tmatch.smoke</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">LogTotalExp</span>, ordering<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Smoker"</span>,<span class="st">"Former"</span>,<span class="st">"Never"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Treatment Variable: Current Smoking Status"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/boxdiff.plot.html">boxdiff.plot</a></span><span class="op">(</span><span class="va">tmatch.packyears</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">LogTotalExp</span>, ordering<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Heavy"</span>,<span class="st">"Moderate"</span>,<span class="st">"Never"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Treatment Variable: Lifetime Smoking Frequency"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="TriMatch_files/figure-html/nmesboxplots-1.png" alt="Boxplot of Differences for NMES" width="50%"><img src="TriMatch_files/figure-html/nmesboxplots-2.png" alt="Boxplot of Differences for NMES" width="50%"><p class="caption">
Boxplot of Differences for NMES
</p>
</div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sum.smoke</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tmatch.smoke</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">LogTotalExp</span>, </span>
<span>ordering<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Smoker"</span>,<span class="st">"Former"</span>,<span class="st">"Never"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sum.packyears</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tmatch.packyears</span>, <span class="va">nmes</span><span class="op">$</span><span class="va">LogTotalExp</span>, </span>
<span>ordering<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Heavy"</span>,<span class="st">"Moderate"</span>,<span class="st">"Never"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Current Smoking Status"</span> <span class="op">=</span> <span class="va">sum.smoke</span>, <span class="st">"Smoking Frequency"</span> <span class="op">=</span> <span class="va">sum.packyears</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   Method Friedman.chi2   Friedman.p     rmANOVA.F    rmANOVA.p</span></span>
<span><span class="co">#&gt; 1 Current Smoking Status      88.92973 4.888274e-20 ***  74.75344 4.985672e-33</span></span>
<span><span class="co">#&gt; 2      Smoking Frequency      33.73246 4.732484e-08 ***  13.72351 1.110186e-06</span></span>
<span><span class="co">#&gt;      </span></span>
<span><span class="co">#&gt; 1 ***</span></span>
<span><span class="co">#&gt; 2 ***</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sum.smoke</span><span class="op">$</span><span class="va">t.tests</span></span>
<span><span class="co">#&gt;              Treatments          t   df      p.value sig  mean.diff     ci.min</span></span>
<span><span class="co">#&gt; 1 Smoker.out-Former.out -11.606558 7407 7.053664e-31 *** -0.4777939 -0.5584907</span></span>
<span><span class="co">#&gt; 2  Smoker.out-Never.out  -2.644559 7407 8.196991e-03  ** -0.1114564 -0.1940737</span></span>
<span><span class="co">#&gt; 3  Former.out-Never.out   9.321687 7407 1.483073e-20 ***  0.3663375  0.2892994</span></span>
<span><span class="co">#&gt;        ci.max</span></span>
<span><span class="co">#&gt; 1 -0.39709714</span></span>
<span><span class="co">#&gt; 2 -0.02883914</span></span>
<span><span class="co">#&gt; 3  0.44337570</span></span>
<span><span class="va">sum.packyears</span><span class="op">$</span><span class="va">t.test</span></span>
<span><span class="co">#&gt;               Treatments          t   df      p.value sig   mean.diff</span></span>
<span><span class="co">#&gt; 1 Heavy.out-Moderate.out -0.3063659 7507 7.593345e-01     -0.01251173</span></span>
<span><span class="co">#&gt; 2    Heavy.out-Never.out  4.3264245 7507 1.535124e-05 ***  0.17925216</span></span>
<span><span class="co">#&gt; 3 Moderate.out-Never.out  4.7239231 7507 2.355422e-06 ***  0.19176389</span></span>
<span><span class="co">#&gt;        ci.min     ci.max</span></span>
<span><span class="co">#&gt; 1 -0.09256793 0.06754447</span></span>
<span><span class="co">#&gt; 2  0.09803395 0.26047036</span></span>
<span><span class="co">#&gt; 3  0.11218788 0.27133989</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" custom-style="Bibliography" entry-spacing="0">
<div id="ref-Austin2008" class="csl-entry">
Austin, Peter. 2008. <span>“A Critical Appraisal of Propensity-Score
Matching in the Medical Literature Between 1996 and 2003.”</span>
<em>Statistics in Medicine</em> 27: 2037–49.
</div>
<div id="ref-Austin2010" class="csl-entry">
———. 2010. <span>“Comparing Paired Vs Non-Paired Statistical Methods of
Analyses When Making Inferences about Absolute Risk Reductions in
Propensity-Score Matched Samples.”</span> <em>Statist. Med.</em> 10:
1292–1301.
</div>
<div id="ref-HelmreichPruzek2008" class="csl-entry">
Helmreich, James E., and Robert M. Pruzek. 2009. <span>“PSAgraphics: An
r Package to Support Propensity Score Analysis.”</span> <em>Journal of
Statistical Software</em> 29 (6): 1–23. <a href="http://www.jstatsoft.org/v29/i06" class="external-link">http://www.jstatsoft.org/v29/i06</a>.
</div>
<div id="ref-Johnson2003" class="csl-entry">
Johnson, Elizabeth, Francesca Dominici, Michael Griswold, and Scott L.
Zeger. 2003. <span>“Disease Cases and Their Medical Costs Attributable
to Smoking: An Analysis of the National Medical Expenditure
Survey.”</span> <em>Journal of Econometrics</em> 112: 135–51.
</div>
<div id="ref-nmes" class="csl-entry">
National Center For Health Services Research. 1987. <span>“National
Medical Expenditure Survey. Methods II. Questionnaires and Data
Collection Methods for the Household Survey and the Survey of American
Indians and Alaska Natives. National Center for Health Services Research
and Health Technology Assessment.”</span>
</div>
<div id="ref-Rosenbaum2012" class="csl-entry">
Rosenbaum, Paul R. 2012. <span>“Testing One Hypothesis Twice in
Observational Studies.”</span> <em>Biometrika</em>, 1–12.
</div>
<div id="ref-RosenbaumRubin1983" class="csl-entry">
Rosenbaum, Paul R., and Donald B. Rubin. 1983. <span>“The Central Role
of the Propensity Score in Observational Studies for Causal
Effects.”</span> <em>Biometrika</em> 70: 41–55.
</div>
<div id="ref-RosenbaumRubin1985" class="csl-entry">
———. 1985. <span>“Constructing a Control Group Using Multivariate
Matched Sampling Methods That Incorporate the Propensity Score.”</span>
<em>The American Statistician</em> 39.
</div>
<div id="ref-ThoemmesKim2011" class="csl-entry">
Thoemmes, Felix J., and Eun Sook Kim. 2011. <span>“A Systematic Review
of Propensity Score Methods in the Social Sciences.”</span>
<em>Multivariate Behavioral Research</em> 46: 90–118.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jason Bryer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
